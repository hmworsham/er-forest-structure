---
title: "Merge Tree Stem GPS Points"
author: "Marshall Worsham - UC Berkeley - worsham@berkeley.edu"
date: "2023-02-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---

## Contents

1 - [Front matter](#front)<br>
2 - [Workspace configuration](#workspace)<br>
3 - [Import reference GPS data index](#gpsindex)<br>
4 - [Exploratory analysis](#explore)<br>
5 - [Read in raw GPS data](#gpsdata)<br>
6 - [Prepare for append](#prep)<br>
7 - [Group by site](#group)<br>

---

## Front matter <a id='front'></a>

This notebook contains markdown and code for post-processing point shapefiles generated from Trimble Geo7X GPS acquisitions in the East River domain. The script appends the `Site` name and `subdirectory` to each shapefile name, then selects all projected point shapefiles, groups them by `Site` name, and merges points from the same site. The result is a set of shapefiles containing tree geolocation points, one set for each site in the watershed where stem geolocations were acquired from 2018â€“2020. Most output files contain some extraneous points marking corners and errata, which are cleaned out in '02_clean_stem_gpspoints.Rmd'. 

This was originally written in Python on 09-21-2020 and translated to R for more efficient processing of shapefiles and better handling of Google Drive imports on 02-21-2023.

## Workspace configuration <a id='workspace'></a>
Load local config file with urls, directory paths. Load local helper functions. 
```{r workspace, include=F}
# Load config
config <- config::get(file=file.path('config', 'config.yml'))

# Load local helper functions and packages
devtools::load_all()
load.pkgs(config$pkgs)

# Configure drive oauth
drive_auth_configure(path=config$driveauth, api_key=readLines(config$drivekey))
drive_auth(email=config$email)
```

## Import reference GPS data index <a id='gpsindex'></a>

```{r gpsindex}
gpsidx <- drive_find(pattern=config$extdata$gpsidx, type='spreadsheet')
gpsidx <- drive_download(
    gpsidx,
    type='xlsx',
    path=tempfile(),
    overwrite=T)$local_path
gpsidx <- read_xlsx(gpsidx)
```

## Exploratory analysis <a id='explore'></a>

Find the number of unique files associated with each site. 
```{r explore}
gpsidx %>%
  group_by(Site) %>%
  summarize(n=n())
```

## Read in raw gps data <a id='gpsdata'></a>

Download data from Drive using local function.
```{r gpsdata}
rgps <- load.rawgps(
  as_id(config$extdata$rawgpsid),
  pattern='Project',
  nmax=950)
```

## Clean and prepare for split <a id='prep'></a>

```{r prep}
# List all raw gps files downloaded
rgps.files <- list.files(tempdir(), full.names=T)

# List unique site names from gpsidx
sitelist = unique(gpsidx$Site)

# Select shapefiles containing tree stem locations in gpsidx
treefiles = gpsidx[grep('tree', gpsidx$Contents),]
treefiles = treefiles[treefiles$Acquisition_Date >= as.POSIXct('2021-01-01'),]
treefiles = treefiles$Filename

# From the set of raw filenames, select those with site names contained in list `treefiles`
rgps.treefiles <- rgps.files[grep(paste(treefiles, collapse='|'), rgps.files)]

# From those, select the .shp extensions
rgps.treefiles <- rgps.treefiles[grep('shp$', rgps.treefiles)]
```

Clean up the list `rgps`
```{r clean}
# Remove non point geometry sf objects from list
rgps <- rgps[which(lapply(rgps, function(x) all(st_geometry_type(x)=='POINT'))==T)]

# Remove sf objects with names that aren't in `treefiles`
rgps <- rgps[grep(paste(treefiles, collapse='|'), rgps)]
```


## Group by site <a id='group'></a>
1. Group files according to site name by finding common value from sitelist in filenames
2. For each site, rowbind the sf objects
4. Project crs to wgs84 utm zone 13
4. Export the sf as a shapefile named: 'GPS_Data_2021_MERGEDBYPLOT_' + <site> + '_'

```{r groupsite}
# Group files by site name
rgps.grouped <- Filter(
  length,
  lapply(sitelist, function(x){
    rgps[grep(x, names(rgps))]
    })
)
```

# Merge stem location observations by site and write to intermediate data
```{r mergewrite}
trees <- lapply(rgps.grouped, merge.stems.by.site, write=T)
```
