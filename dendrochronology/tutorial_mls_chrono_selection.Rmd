---
title: "Multiple linear regression for chronology selection"
author: "Marshall Worsham"
date: "10/14/2022"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### What Timilsena means by multiple linear regression for chronology selection

Timilsena is citing [Meko 2001]('https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwiv_7j_5OD6AhWzJn0KHZelAT8QFnoECAkQAQ&url=https%3A%2F%2Fwww.waterboards.ca.gov%2Fwaterrights%2Fwater_issues%2Fprograms%2Fbay_delta%2Fdeltaflow%2Fdocs%2Fexhibits%2Fccwd%2Fspprt_docs%2Fccwd_meko_etal_2001a.pdf&usg=AOvVaw1divfoZ8n-Nh0Claqs_xpj'). From that paper: 

**“Water-year total precipitation at a site was then regressed against the site chronology in a distributed lag regression model, using the tree-ring chronology in years t, t+1,and t+2 as the predictors of precipitation in year t. Chronologies with regression R^2^<0.10 ...  were dropped from the analysis.” (Meko et al. 2001)**

Basically, Meko and colleagues used a linear regression to examine how well each tree-ring chronology would do as an independent explainer of precipitation (P). Then they removed the chronologies that weren’t very good explainers. 

In formal terms, their test asked whether P in a given year could be estimated as a linear function of the tree ring width measured in that year, plus the tree-ring width measured one year later, plus tree-ring width measured two years later. This would have had the functional form:

$ŷ = \beta_1X_t + \beta_2X_{t+1}~ + \beta_3X_{t+2}$

  + ŷ = a time series of precip values
  + X~t~ = time series of tree ring widths corresponding to the same year in which the streamflow observation was taken
  + X~t+1~ = time series of tree ring widths corresponding to the year after the streamflow observation was taken
  + X~t+2~ = time series of tree ring widths corresponding to two years after the streamflow observation was taken
  + $\beta$ = coefficient that modifies the contribution of each X to the overall estimate, ŷ

If this regression found a relationship between the response and explainers with an R^2^>0.10, they kept the chronology to use as an indepenent variable in their subsequent predictive model; otherwise they excluded it. Meko et al. did this over and over again, across all of the available chronologies from the Sacramento River basin, to select a decent predictor set.

### Let's make some reasonable dummy data
Below I'm just creating some dummy data that shows how you might set up this kind of analysis. 

```{r}
library(dplyr, quiet=T)
library(stats, quiet=T)

t <- 152 # length of the time series (number of years of observation); 152 is arbitrary
t.seq <- 1:t # a sequence from year 1 to year t

# Generate 152 random observations for dummy precip data
set.seed(42) # Set the random number generator seed for reproducibility
P <- abs(0.2*sin(t.seq)+runif(t.seq))*1000 # 152 observations between 0 mm and 1000 mm a year, a reasonable range

# Make the chronology to regress against the precip data
# Generate 152 observations of dummy ringwidth data
set.seed(999)
rw <- abs(0.2*sin(t.seq)+runif(t.seq))*100

# Lag rw by 1 and 2 years
rw.1 <- lead(rw, 1L)
rw.2 <- lead(rw, 2L)

# Bring it all together in a dataframe
df <- data.frame('year'=t.seq, 'precip'=P, 'rw'=rw, 'rw_lag1'=rw.1, 'rw_lag2'=rw.2)
```

In the resulting dataframe, the first column indexes the years, the second column contains values for the response variable (ŷ, precipitation) over the time series t~1~→t~j~ (i.e., Observation 1 through Observation j), and the remaining columns containt the ring width measurements and their 1- and 2-year lags.

```{r}
# Show the dataframe
head(df)
```

Here's the same data plotted over the time support. 

```{r}

# Plot the time series
par(tcl = 0.5, mar = rep(2.2, 4)+.3, mgp = c(1.1, 0.1, 0),xaxs="i")
plot(df$year,rep(1,t), 
     type="n", 
     axes=FALSE, 
     ylab="Precip (mm)", 
     xlab="Time (n years)", 
     ylim=c(0,1000))
lines(df$year, df$precip, type='l', col='blue', lwd=2)
lines(df$rw, type='l', col='springgreen4')
lines(df$rw_lag1, type='l', col='springgreen3')
lines(df$rw_lag2, type='l', col='palegreen1')
mtext("Ring width (um)", side = 4, line = 1)  
legend("topright", c("precip", "rw", "rw_lag1", "rw_lag2"), lwd = 2,
       col = c("blue", "springgreen4", "springgreen3", "palegreen1"),
       bg = "white")
axis(1);axis(2); axis(4)
box()
```

Now, to do a linear regression here, we'd ignore the time component and just try to find a line of best fit between the precip values and the ring width values corresponding to each time step. The workflow for that follows below. 

### Multiple linear regression
First, let's take a look at the data just as coeval observations, i.e., with the time component removed.
```{r}
plot(df$precip, df$rw)
points(df$precip, df$rw_lag1, col='red')
points(df$precip, df$rw_lag2, col='orange')
```

They don't look particularly well correlated, and the spread is wide, but let's do the regression to see what the stats say. 

```{r}
mlm <- lm(precip ~ rw+rw_lag1+rw_lag2, data=df)
summary(mlm)
```

So, it appears that our multiple R^2^ < 0.10, so on Meko et al.'s criterion, we'd have to throw this chronology out. If it were > 0.10, we'd keep it. Ideally, across a set of many chronologies, you'd be able to keep several. 
